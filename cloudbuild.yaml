steps:
  - name: "gcr.io/cloud-builders/wget"
    args:
      [
        "-O",
        "/tmp/git-lfs.tar.gz",
        "https://github.com/git-lfs/git-lfs/releases/download/v2.13.3/git-lfs-linux-amd64-v2.13.3.tar.gz",
      ]

  - name: "alpine:latest"
    entrypoint: "tar"
    args: ["-xvzf", "/tmp/git-lfs.tar.gz", "-C", "/tmp"]

  - name: "gcr.io/cloud-builders/git"
    args: ["/tmp/git-lfs-2.13.3/git-lfs", "install"]

  - name: "gcr.io/cloud-builders/git"
    args: ["lfs", "pull"]

  - name: "gcr.io/cloud-builders/docker"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        echo "$$GOOGLE_APPLICATION_CREDENTIALS_CONTENT" > /workspace/service-account-key.json
        export GOOGLE_APPLICATION_CREDENTIALS="/workspace/service-account-key.json"

  - name: "gcr.io/cloud-builders/docker"
    args: ["build", "-t", "gcr.io/$PROJECT_ID/learn-language-flask-app", "."]

  - name: "gcr.io/cloud-builders/docker"
    args: ["push", "gcr.io/$PROJECT_ID/learn-language-flask-app"]

  - name: "gcr.io/cloud-builders/gcloud"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        export GOOGLE_APPLICATION_CREDENTIALS="/workspace/service-account-key.json"
        gcloud beta run deploy learn-language-flask-app --image gcr.io/$PROJECT_ID/learn-language-flask-app --region us-central1 --platform managed
